---
- name: Checking if any temporary files exist prior to cleanup
  stat: path=../tmp
  register: temp_directory
  tags:
    - prepUpgradeEnv

- name: Cleaning up temporary directories prior to getting intent data
  file:
    path: "../tmp"
    state: absent
  when: temp_directory.stat.exists
  tags:
    - prepUpgradeEnv

- name: Create Directory tmp for storing files to compare
  file:
    path: "../tmp"
    state: directory
  tags:
    - prepUpgradeEnv

- name: Pass the upgrade variable upstream to be used by the App workflow during the upgrade
  set_stats:
    data:
      upgrade: "{{ upgrade }}"
  tags:
    - prepUpgradeEnv

- name: Wait a maximum of 60 seconds for BIG-IP to be ready to take configuration
  bigip_wait:
    delay: 10
    timeout: 60
    provider: "{{ provider }}"
  tags:
    - prepUpgradeEnv

- name: REST Call to check for the status of AS3 Declaration
  uri:
    url: "https://{{inventory_hostname}}:{{bigip_port}}/{{ as3RpmCheckUri }}"
    method: GET
    return_content: yes
    status_code: [200, 202]
    url_username: "{{bigip_username}}"
    url_password: "{{bigip_password}}"
    force_basic_auth: yes
    validate_certs: no
  register: AS3_presence_check
  until: AS3_presence_check.status == 200
  retries: 5
  delay: 5
  tags:
    - prepUpgradeEnv
